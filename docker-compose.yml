services:
    server:
        depends_on:
            - mongo
            - rabbitmq
        restart: on-failure
        build:
            context: .
            dockerfile: server.Dockerfile
        container_name: server
        ports:
            - '80:80'
        env_file: ./.env
        environment:
            - PORT=80
            - MONGO_HOST=mongo
            - RABBITMQ_HOST=rabbitmq
        volumes:
            - ./api/data:/app/api/data
    
    tasks-consumer:
        depends_on:
            - mongo
            - rabbitmq
            - server
        restart: on-failure
        build:
            context: .
            dockerfile: tasks-consumer.Dockerfile
        container_name: tasks-consumer
        env_file: ./.env
        volumes:
            - ./api/data:/app/api/data
    
    mongo:
        image: mongo:8
        restart: always
        container_name: 'mongo'
        ports:
            - '27017:27017'
        env_file: ./.env
        command: mongod --logpath /var/log/mongodb/mongod.log --logRotate reopen --logappend
        logging:
            driver: 'json-file'
            options:
                max-size: '10m'
                max-file: '3'
        volumes:
            - mongo-data:/data/db
            - mongo-config:/data/configdb
            - ./scripts/init-mongo.js:/docker-entrypoint-initdb.d/01-init-mongo.js:ro
            - ./scripts/init-restore.sh:/docker-entrypoint-initdb.d/02-init-restore.sh:ro
            - ./backups:/backups
        healthcheck:
            test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
            interval: 10s
            timeout: 5s
            retries: 5
    
    mongo_backup:
        image: mongo:8
        restart: unless-stopped
        container_name: 'mongo_backup'
        depends_on:
            mongo:
                condition: service_healthy
        env_file: ./.env
        environment:
            - MONGO_HOST=mongo
            - MONGO_PORT=27017
            - BACKUP_RETENTION=1
        volumes:
            - ./backups:/backups
            - ./scripts/backup.sh:/scripts/backup.sh
            - ./scripts/restore.sh:/scripts/restore.sh
            - ./scripts/crontab:/scripts/crontab
        command: >
            bash -c "
                set -e &&
                apt-get update -qq &&
                apt-get install -y -qq cron &&
                chmod +x /scripts/backup.sh /scripts/restore.sh &&
                crontab /scripts/crontab &&
                cron -f
            "
    
    rabbitmq:
        image: 'rabbitmq:management'
        container_name: 'rabbitmq'
        ports:
            - '5672:5672'
            - '15672:15672'
        env_file: ./.env

volumes:
    mongo-data:
    mongo-config: