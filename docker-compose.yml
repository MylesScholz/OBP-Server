services:    
    mongo:
        container_name: mongo
        image: mongo:8
        restart: always
        ports:
            - '27017:27017'
        env_file: ./.env
        command: mongod --wiredTigerCacheSizeGB 0.5 --logpath /var/log/mongodb/mongod.log --logRotate reopen --logappend
        logging:
            driver: 'json-file'
            options:
                max-size: '10m'
                max-file: '3'
        volumes:
            - mongo-data:/data/db
            - mongo-config:/data/configdb
            - ./scripts/init-mongo.js:/docker-entrypoint-initdb.d/init-mongo.js:ro
            - ./backups:/backups
        healthcheck:
            test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
            interval: 10s
            timeout: 5s
            retries: 5
    
    mongo-backup:
        container_name: mongo-backup
        image: alpine:3.19
        depends_on:
            mongo:
                condition: service_healthy
        restart: unless-stopped
        env_file: ./.env
        environment:
            - MONGO_HOST=mongo
            - MONGO_PORT=27017
            - BACKUP_RETENTION=1
        volumes:
            - ./backups:/backups
            - ./scripts/backup.sh:/scripts/backup.sh
            - ./scripts/restore.sh:/scripts/restore.sh
            - ./scripts/crontab:/scripts/crontab
        command: >
            sh -c "
                set -e &&
                apk add --no-cache mongodb-tools dcron bash &&
                chmod +x /scripts/backup.sh /scripts/restore.sh &&
                printenv | grep -v 'no_proxy' > /etc/environment &&
                crontab /scripts/crontab &&
                crond -f -l 2
            "
    
    rabbitmq:
        container_name: rabbitmq
        image: 'rabbitmq:management'
        ports:
            - '5672:5672'
            - '15672:15672'
        env_file: ./.env
        healthcheck:
            test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s

    server:
        container_name: server
        build: ./server
        depends_on:
            mongo:
                condition: service_healthy
            rabbitmq:
                condition: service_healthy
        restart: on-failure
        ports:
            - '3000:3000'
        env_file: ./.env
        environment:
            - PORT=3000
            - MONGO_HOST=mongo
            - RABBITMQ_HOST=rabbitmq
        volumes:
            - ./server/src:/app/src
            - ./shared:/app/shared
    
    worker:
        container_name: worker
        build: ./worker
        depends_on:
            mongo:
                condition: service_healthy
            rabbitmq:
                condition: service_healthy
            server:
                condition: service_started
        restart: on-failure
        env_file: ./.env
        environment:
            - MONGO_HOST=mongo
            - RABBITMQ_HOST=rabbitmq
        volumes:
            - ./worker/src:/app/src
            - ./shared:/app/shared

    nginx:
        container_name: nginx
        image: nginx:alpine
        ports:
            - '80:80'
            - '443:443'
        volumes:
            - ./nginx/nginx.conf:/etc/nginx/nginx.conf
            - ./client/dist:/usr/share/nginx/html
        depends_on:
            - server

volumes:
    mongo-data:
    mongo-config: